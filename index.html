<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’¡ ë²•ë¥  ìƒì‹ í€´ì¦ˆ ğŸ’¡</title>
    
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --font-color: #343a40;
            --background-color: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--font-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* ëª¨ë“  í™”ë©´ ê³µí†µ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .screen-container {
            width: 100%;
            max-width: 800px;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë‘ ìˆ¨ê¹€ */
        }

        /* í™œì„±í™”ëœ í™”ë©´ë§Œ í‘œì‹œ */
        .screen-container.active {
            display: block;
        }

        h1 { color: var(--primary-color); margin-bottom: 30px; }
        h2 { color: var(--font-color); margin-bottom: 20px; }

        /* --- ë²„íŠ¼ ìŠ¤íƒ€ì¼ --- */
        .btn {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 10px auto;
            padding: 15px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            color: white;
            font-weight: bold;
        }
        
        .btn:active { transform: translateY(2px); }
        .btn-primary { background-color: var(--primary-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-success:hover { background-color: #218838; }
        .btn-secondary:hover { background-color: #5a6268; }

        /* --- ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ --- */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ë¡œë”© íƒ€ì´ë¨¸ í…ìŠ¤íŠ¸ */
        #loading-timer {
            font-size: 1.2em;
            color: var(--primary-color);
            font-weight: bold;
            margin-top: 10px;
        }

        /* --- í€´ì¦ˆ ê´€ë ¨ ìŠ¤íƒ€ì¼ --- */
        #quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        
        #timer {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--danger-color);
            padding: 5px 15px;
            border: 2px solid var(--danger-color);
            border-radius: 8px;
        }

        #question-text {
            font-size: 1.3em;
            font-weight: 500;
            margin-bottom: 20px;
            background-color: #f1f3f5;
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
            text-align: left;
        }

        .option-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            text-align: left;
            border: 1px solid #ced4da;
            border-radius: 8px;
            background-color: white;
            color: var(--font-color);
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-button:hover:not([disabled]) { background-color: #e9ecef; border-color: var(--primary-color); }
        
        .correct { background-color: #d4edda !important; border-color: var(--success-color) !important; }
        .incorrect { background-color: #f8d7da !important; border-color: var(--danger-color) !important; }

        /* --- í•´ì„¤ ë° í”¼ë“œë°± --- */
        #explanation-area {
            border-top: 2px dashed var(--secondary-color);
            padding-top: 20px;
            margin-top: 25px;
            text-align: left;
        }
        #feedback-message { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; padding: 10px; border-radius: 5px; text-align: center; }
        .feedback-correct { background-color: #d4edda; color: var(--success-color); }
        .feedback-incorrect { background-color: #f8d7da; color: var(--danger-color); }
        #explanation-content { white-space: pre-wrap; background-color: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid var(--warning-color); color: #856404; }

        /* --- ë³µìŠµ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ --- */
        .review-item { text-align: left; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px; background-color: #f8f9fa; }
        .review-info { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .review-info.user-answer { background-color: #fff3cd; }
        .review-info.correct-answer { background-color: #d4edda; }
        .review-info.explanation { background-color: #e6f7ff; border-left: 4px solid var(--primary-color); }
    </style>
</head>
<body>

    <div id="start-screen" class="screen-container active">
        <h1>âš–ï¸ ë²•ë¥  ìƒì‹ í€´ì¦ˆ</h1>
        <p style="margin-bottom: 30px; font-size: 1.1em;">
            ë§¤ì¼ ìƒˆë¡œìš´ ë²•ë¥  ìƒì‹ì„ í€´ì¦ˆë¡œ ë°°ì›Œë³´ì„¸ìš”.<br>
            í•œ ì„¸íŠ¸ë‹¹ 5ë¬¸ì œê°€ ì¶œì œë©ë‹ˆë‹¤.
        </p>
        <button class="btn btn-primary" onclick="handleStartNewQuiz()">âœ¨ ìƒˆ í€´ì¦ˆ ìƒì„± ë° ì‹œì‘</button>
        <button class="btn btn-success" onclick="handleEnterReviewMode()">ğŸ“š ì§€ë‚œ ì˜¤ë‹µ ë³µìŠµí•˜ê¸°</button>
    </div>

    <div id="loading-screen" class="screen-container">
        <div class="loader"></div>
        <h2>AIê°€ í€´ì¦ˆë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</h2>
        <p>ìµœì‹  ë²•ë ¹ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ë¬¸ì œë¥¼ ì¶œì œ ì¤‘ì…ë‹ˆë‹¤.<br>ìµœëŒ€ 60ì´ˆê¹Œì§€ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <p id="loading-timer">0ì´ˆ ê²½ê³¼</p>
    </div>

    <div id="quiz-screen" class="screen-container">
        <div id="quiz-header">
            <div id="quiz-status">
                ë¬¸ì œ: <span id="current-quiz-index">0</span> / <span id="total-quiz-count">0</span>
                | ì •ë‹µ: <span id="correct-count">0</span>
            </div>
            <div id="timer">15s</div>
        </div>
        
        <div id="question-text"></div>
        <div id="options-container"></div>

        <div id="explanation-area" style="display: none;">
            <div id="feedback-message"></div>
            <h3>ğŸ” í•´ì„¤</h3>
            <p id="explanation-content"></p>
        </div>

        <button id="next-button" class="btn btn-primary" style="display: none;">ë‹¤ìŒ ë¬¸ì œ</button>
    </div>

    <div id="result-screen" class="screen-container">
        <h2>ğŸ‰ í€´ì¦ˆ ì™„ë£Œ!</h2>
        <p style="font-size: 1.2em;">ì´ ì •ë‹µ: <strong id="final-correct-count" style="color: var(--primary-color);"></strong> / <span id="final-total-count"></span></p>
        <p style="font-size: 1.2em;">ì ìˆ˜: <strong id="final-score"></strong>ì </p>
        
        <button class="btn btn-success" onclick="handleEnterReviewMode()">ğŸ“š ì˜¤ë‹µ ë…¸íŠ¸ í™•ì¸</button>
        <button class="btn btn-secondary" onclick="showScreen('start-screen')">ğŸ  ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <div id="review-screen" class="screen-container">
        <h1>ğŸ“š ì˜¤ë‹µ ë…¸íŠ¸</h1>
        <div id="review-list"></div>
        <button class="btn btn-secondary" onclick="showScreen('start-screen')">ğŸ  ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <script>
        const QUIZ_API_URL = '/api/quizzes';
        const STORAGE_KEY_QUIZZES = 'lawQuizzesData';
        const STORAGE_KEY_PROGRESS = 'lawQuizProgress';
        
        let allQuizzes = [];
        let currentQuizIndex = 0;
        let correctCount = 0;
        let timerInterval;
        let isAnswered = false;
        
        // ë¡œë”© íƒ€ì´ë¨¸ ë³€ìˆ˜ ì¶”ê°€
        let loadingInterval;
        let loadingSeconds = 0;

        // --- í™”ë©´ ì „í™˜ í—¬í¼ ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen-container').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // --- ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬ ---
        function saveProgress() {
            const progress = { index: currentQuizIndex, correct: correctCount, total: allQuizzes.length };
            localStorage.setItem(STORAGE_KEY_PROGRESS, JSON.stringify(progress));
        }
        function loadProgress() { return JSON.parse(localStorage.getItem(STORAGE_KEY_PROGRESS)); }
        function saveQuizzes() { localStorage.setItem(STORAGE_KEY_QUIZZES, JSON.stringify(allQuizzes)); }
        function loadQuizzesFromStorage() { return JSON.parse(localStorage.getItem(STORAGE_KEY_QUIZZES)); }
        function clearStorage() {
            localStorage.removeItem(STORAGE_KEY_QUIZZES);
            localStorage.removeItem(STORAGE_KEY_PROGRESS);
        }

        // --- ë¡œë”© íƒ€ì´ë¨¸ í•¨ìˆ˜ ---
        function startLoadingTimer() {
            loadingSeconds = 0;
            const timerEl = document.getElementById('loading-timer');
            timerEl.textContent = "0ì´ˆ ê²½ê³¼";
            
            if (loadingInterval) clearInterval(loadingInterval);
            
            loadingInterval = setInterval(() => {
                loadingSeconds++;
                timerEl.textContent = `${loadingSeconds}ì´ˆ ê²½ê³¼`;
                
                // 30ì´ˆê°€ ë„˜ì–´ê°€ë©´ ë©˜íŠ¸ë¥¼ ë°”ê¿”ì£¼ì–´ ì•ˆì‹¬ì‹œí‚´
                if(loadingSeconds === 30) {
                     timerEl.textContent = `${loadingSeconds}ì´ˆ ê²½ê³¼ (ì¡°ê¸ˆë§Œ ë” ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!)`;
                }
            }, 1000);
        }

        function stopLoadingTimer() {
            if (loadingInterval) clearInterval(loadingInterval);
        }

        // --- í•¸ë“¤ëŸ¬: ìƒˆ í€´ì¦ˆ ì‹œì‘ ---
        async function handleStartNewQuiz() {
            showScreen('loading-screen'); 
            startLoadingTimer(); // ë¡œë”© íƒ€ì´ë¨¸ ì‹œì‘

            try {
                clearStorage(); 

                const response = await fetch(QUIZ_API_URL);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                
                allQuizzes = await response.json();
                
                if (!allQuizzes || allQuizzes.length === 0) {
                    throw new Error("ë°›ì•„ì˜¨ í€´ì¦ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }

                currentQuizIndex = 0;
                correctCount = 0;
                saveQuizzes();
                saveProgress();

                stopLoadingTimer(); // ë¡œë”© íƒ€ì´ë¨¸ ì¤‘ì§€
                startQuizFlow();

            } catch (error) {
                stopLoadingTimer(); // ì—ëŸ¬ ì‹œì—ë„ íƒ€ì´ë¨¸ ì¤‘ì§€
                console.error(error);
                alert(`í€´ì¦ˆ ìƒì„± ì‹¤íŒ¨: ${error.message}\n(ì„œë²„ ì‘ë‹µ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.)`);
                showScreen('start-screen');
            }
        }

        // --- í•¸ë“¤ëŸ¬: ë³µìŠµ ëª¨ë“œ ---
        function handleEnterReviewMode() {
            const storedQuizzes = loadQuizzesFromStorage();
            if (!storedQuizzes || storedQuizzes.length === 0) {
                alert("ì €ì¥ëœ í€´ì¦ˆ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìƒˆ í€´ì¦ˆë¥¼ í’€ì–´ë³´ì„¸ìš”!");
                return;
            }
            allQuizzes = storedQuizzes;
            showReviewScreen();
        }

        // --- í€´ì¦ˆ ì§„í–‰ íë¦„ ---
        function startQuizFlow() {
            showScreen('quiz-screen');
            updateQuizUI();
        }

        // --- UI ì—…ë°ì´íŠ¸ ---
        function updateQuizUI() {
            if (currentQuizIndex >= allQuizzes.length) {
                showResults();
                return;
            }

            isAnswered = false;
            document.getElementById('next-button').style.display = 'none';
            document.getElementById('explanation-area').style.display = 'none';
            
            const quiz = allQuizzes[currentQuizIndex];
            
            document.getElementById('current-quiz-index').textContent = currentQuizIndex + 1;
            document.getElementById('total-quiz-count').textContent = allQuizzes.length;
            document.getElementById('correct-count').textContent = correctCount;
            
            document.getElementById('question-text').innerHTML = 
                `<span style="color: var(--secondary-color); font-size: 0.9em;">(${quiz.source_law_name})</span><br>${quiz.question}`;
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            quiz.options.forEach((option, idx) => {
                const btn = document.createElement('button');
                btn.className = 'option-button';
                btn.textContent = `${idx + 1}. ${option.text}`;
                btn.dataset.isCorrect = option.is_correct;
                btn.onclick = () => checkAnswer(btn, quiz);
                container.appendChild(btn);
            });

            startTimer(quiz.timer_sec || 15);
        }

        // --- ì •ë‹µ ì²´í¬ ---
        function checkAnswer(selectedBtn, quiz) {
            if (isAnswered) return;
            isAnswered = true;
            clearInterval(timerInterval);

            const isTimeUp = !selectedBtn;
            const isCorrect = isTimeUp ? false : selectedBtn.dataset.isCorrect === 'true';

            quiz.is_correct_answered = isCorrect;
            quiz.user_answer_text = isTimeUp ? "â° ì‹œê°„ ì´ˆê³¼" : selectedBtn.textContent;
            saveQuizzes();

            const feedbackEl = document.getElementById('feedback-message');
            if (isCorrect) {
                correctCount++;
                feedbackEl.textContent = "âœ… ì •ë‹µì…ë‹ˆë‹¤!";
                feedbackEl.className = 'feedback-correct';
            } else {
                feedbackEl.textContent = isTimeUp ? "â° ì‹œê°„ ì´ˆê³¼!" : "âŒ ì˜¤ë‹µì…ë‹ˆë‹¤.";
                feedbackEl.className = 'feedback-incorrect';
                if (selectedBtn) selectedBtn.classList.add('incorrect');
            }
            document.getElementById('correct-count').textContent = correctCount;

            document.querySelectorAll('.option-button').forEach(btn => {
                btn.disabled = true;
                if (btn.dataset.isCorrect === 'true') btn.classList.add('correct');
            });

            document.getElementById('explanation-content').textContent = quiz.explanation;
            document.getElementById('explanation-area').style.display = 'block';
            
            const nextBtn = document.getElementById('next-button');
            nextBtn.textContent = (currentQuizIndex < allQuizzes.length - 1) ? "ë‹¤ìŒ ë¬¸ì œ" : "ê²°ê³¼ ë³´ê¸°";
            nextBtn.style.display = 'block';
            nextBtn.onclick = () => {
                currentQuizIndex++;
                saveProgress();
                updateQuizUI();
            };

            saveProgress();
        }

        // --- ë¬¸ì œ íƒ€ì´ë¨¸ ---
        function startTimer(seconds) {
            let left = seconds;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = `${left}s`;
            
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                left--;
                timerEl.textContent = `${left}s`;
                if (left <= 0) {
                    clearInterval(timerInterval);
                    if (!isAnswered) checkAnswer(null, allQuizzes[currentQuizIndex]);
                }
            }, 1000);
        }

        // --- ê²°ê³¼ í™”ë©´ ---
        function showResults() {
            clearInterval(timerInterval);
            if (currentQuizIndex < allQuizzes.length) {
                currentQuizIndex = allQuizzes.length;
                saveProgress();
            }

            document.getElementById('final-correct-count').textContent = correctCount;
            document.getElementById('final-total-count').textContent = allQuizzes.length;
            document.getElementById('final-score').textContent = Math.round((correctCount / allQuizzes.length) * 100);
            
            showScreen('result-screen');
        }

        // --- ë³µìŠµ í™”ë©´ ---
        function showReviewScreen() {
            const listContainer = document.getElementById('review-list');
            listContainer.innerHTML = '';

            const wrongQuizzes = allQuizzes.filter(q => q.is_correct_answered === false);

            if (wrongQuizzes.length === 0) {
                listContainer.innerHTML = '<div style="padding:20px; color:var(--success-color);">ğŸ‰ í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤! ì™„ë²½í•©ë‹ˆë‹¤.</div>';
            } else {
                wrongQuizzes.forEach((q, idx) => {
                    const item = document.createElement('div');
                    item.className = 'review-item';
                    
                    const correctOption = q.options.find(o => o.is_correct);
                    
                    item.innerHTML = `
                        <h3>${idx + 1}. ${q.question}</h3>
                        <div class="review-info user-answer">
                            <strong>ë‚´ ë‹µë³€:</strong> <span style="color:var(--danger-color)">${q.user_answer_text || '-'}</span>
                        </div>
                        <div class="review-info correct-answer">
                            <strong>ì •ë‹µ:</strong> ${correctOption ? correctOption.text : '?'}
                        </div>
                        <div class="review-info explanation">
                            <strong>í•´ì„¤:</strong> ${q.explanation}
                        </div>
                    `;
                    listContainer.appendChild(item);
                });
            }
            showScreen('review-screen');
        }

        // --- ì´ˆê¸° ì‹¤í–‰ ---
        document.addEventListener('DOMContentLoaded', () => {
            showScreen('start-screen');
        });
    </script>
</body>
</html>