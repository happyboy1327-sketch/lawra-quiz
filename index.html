<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë²•ë¥  í€´ì¦ˆ</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: 'Inter', 'Noto Sans KR', Arial, sans-serif; margin:0; padding:0; }
.modal-overlay { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease-in-out; }
</style>
<script>
tailwind.config = {
  theme: { extend: { colors: { 'primary':'#1976d2','primary-dark':'#1565c0','correct':'#4caf50','wrong':'#f44336','bg-light':'#f0f2f5' } } }
}
</script>
</head>
<body class="bg-bg-light min-h-screen p-4 flex justify-center items-start">

<div id="quiz-container" class="max-w-xl w-full mx-auto mt-5 p-6 bg-white rounded-xl shadow-2xl relative border border-gray-100">
  <div class="flex justify-between items-center mb-4 relative h-10">
    <button id="review-button" class="px-3 py-1 text-sm font-semibold text-white bg-primary hover:bg-primary-dark rounded-lg shadow-md">ì˜¤ë‹µ ë³µìŠµ</button>
    <div class="flex flex-col items-end space-y-1">
      <div id="timer" class="text-xl font-bold text-gray-700">0</div>
      <div id="wrong-count" class="text-sm font-semibold text-wrong">ì˜¤ë‹µ: 0</div>
    </div>
  </div>

  <div id="question-text" class="mt-8 mb-6 text-lg font-medium text-gray-800 leading-relaxed min-h-[4rem]">
    {ì§ˆë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.}
  </div>

  <div id="options-container" class="space-y-3"></div>

  <div id="explanation-area" class="mt-4 p-4 text-sm bg-blue-50 border-l-4 border-primary rounded-lg text-gray-700 hidden transition-all duration-300"></div>

  <button id="next-button" class="w-full mt-6 py-3 border-none rounded-lg bg-primary text-white text-base font-semibold cursor-pointer hover:bg-primary-dark transition duration-200 shadow-lg hover:shadow-xl">ë‹¤ìŒ ë¬¸ì œ</button>

  <button id="new-quiz-set-btn" class="w-full mt-3 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-200">
    ìƒˆ í€´ì¦ˆ ì„¸íŠ¸ ìƒì„±
  </button>

</div>

<div id="review-modal" class="fixed inset-0 flex items-center justify-center modal-overlay opacity-0 pointer-events-none z-50 transition duration-300">
  <div class="bg-white rounded-xl w-11/12 max-w-2xl max-h-[80vh] overflow-y-auto p-6 shadow-2xl transform scale-95 transition-transform duration-300">
    <h2 class="text-xl font-bold mb-4 border-b pb-2 text-gray-800">ì˜¤ë‹µ ë³µìŠµ ëª©ë¡</h2>
    <div id="review-list" class="space-y-3"></div>
    <button id="review-close" class="mt-6 w-full py-2 bg-wrong text-white font-semibold rounded-lg hover:bg-red-700 shadow-md">ë‹«ê¸°</button>
  </div>
</div>

<script type="module">
let allQuizzes=[], currentQuizIndex=0, correctCount=0, wrongQuizzes=[];
const questionTextEl=document.getElementById("question-text");
const optionsContainerEl=document.getElementById("options-container");
const explanationAreaEl=document.getElementById("explanation-area");
const nextButtonEl=document.getElementById("next-button");
const newQuizSetBtnEl = document.getElementById("new-quiz-set-btn");
const reviewButtonEl=document.getElementById("review-button");
const reviewModalEl=document.getElementById("review-modal");
const reviewListEl=document.getElementById("review-list");
const reviewCloseEl=document.getElementById("review-close");
const timerEl=document.getElementById("timer");
const wrongCountEl=document.getElementById("wrong-count");
let timerInterval;

// ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë³µì›
wrongQuizzes=JSON.parse(localStorage.getItem("wrongQuizzes")||"[]");

function showModal(){ reviewModalEl.classList.remove('opacity-0','pointer-events-none'); reviewModalEl.children[0].classList.remove('scale-95'); reviewModalEl.children[0].classList.add('scale-100'); }
function hideModal(){ reviewModalEl.classList.add('opacity-0','pointer-events-none'); reviewModalEl.children[0].classList.remove('scale-100'); reviewModalEl.children[0].classList.add('scale-95'); }

// Firestoreì—ì„œ í€´ì¦ˆ ê°€ì ¸ì˜¤ê¸°
async function loadQuizzes(){
  try{
    const res=await fetch("/api/lawquizzes/latest");
    
    if(!res.ok){
      // ì„œë²„ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
      const err = await res.json();
      throw new Error(err.error || `í€´ì¦ˆ ë¡œë“œ ì‹¤íŒ¨ (Status: ${res.status})`);
    }

    allQuizzes=await res.json();
    if (allQuizzes.length === 0) {
        questionTextEl.innerHTML = `í€´ì¦ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒˆ í€´ì¦ˆ ì„¸íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.`;
        nextButtonEl.classList.add("hidden");
        return;
    }
    
    currentQuizIndex=0;
    correctCount=0;
    showQuiz();
    updateWrongCount();
    nextButtonEl.classList.remove("hidden");

  }catch(err){ 
    console.error(err); 
    questionTextEl.innerHTML = `âš ï¸ í€´ì¦ˆ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`;
    nextButtonEl.classList.add("hidden");
    newQuizSetBtnEl.classList.remove("hidden");
  }
}

function showQuiz(){
  clearInterval(timerInterval);
  timerEl.classList.remove("text-wrong");
  
  const quiz=allQuizzes[currentQuizIndex];
  
  // âœ… ë””ë²„ê¹… ì¶”ê°€
  console.log('showQuiz í˜¸ì¶œ');
  console.log('currentQuizIndex:', currentQuizIndex);
  console.log('allQuizzes:', allQuizzes);
  console.log('quiz:', quiz);
  
  if(!quiz){ 
    console.warn("í€´ì¦ˆ ì—†ìŒ"); 
    questionTextEl.innerHTML = "í€´ì¦ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
    return; 
  }

  questionTextEl.innerHTML=`<span class="text-sm font-light text-gray-500 mr-2">[${currentQuizIndex+1}/${allQuizzes.length}]</span>
    <span class="text-primary font-bold mr-2">(${quiz.category})</span>${quiz.question}`;
  

  optionsContainerEl.innerHTML="";
  explanationAreaEl.classList.add("hidden"); explanationAreaEl.textContent="";
  explanationAreaEl.classList.remove("bg-red-100", "border-wrong", "bg-yellow-100", "border-yellow-500", "text-center", "font-bold", "text-lg");
  explanationAreaEl.classList.add("bg-blue-50", "border-primary");
  nextButtonEl.disabled=true;
  nextButtonEl.classList.add("opacity-50","cursor-not-allowed");
  nextButtonEl.classList.remove("hover:bg-primary-dark");

  quiz.options.forEach((opt,index)=>{
    const btn=document.createElement("button");
    btn.className="option-button w-full text-left p-4 border border-gray-300 rounded-xl cursor-pointer bg-white hover:bg-gray-50 text-gray-700 font-medium shadow-sm";
    btn.textContent=`${index+1}. ${opt.text}`;
    btn.dataset.isCorrect=opt.is_correct;
    btn.addEventListener("click",()=>checkAnswer(btn,quiz));
    optionsContainerEl.appendChild(btn);
  });

  // quiz ê°ì²´ì— timer_secì´ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’ 15ì´ˆ ì‚¬ìš©
  startTimer(quiz.timer_sec || 15); 
}

function checkAnswer(btn,quiz){
  if(btn.disabled) return; // ì´ë¯¸ ì„ íƒë˜ì—ˆìœ¼ë©´ ë¬´ì‹œ

  clearInterval(timerInterval);
  const correct=btn.dataset.isCorrect==="true";
  quiz.selectedAnswer=btn.textContent.replace(/^\d+\.\s*/,"");

  Array.from(optionsContainerEl.children).forEach(b=>{
    b.disabled=true; b.classList.add("cursor-default"); b.classList.remove("hover:bg-gray-50");
    if(b.dataset.isCorrect==="true"){ b.classList.add("bg-correct","text-white","border-correct","shadow-md"); b.classList.remove("bg-white","text-gray-700","border-gray-300"); }
    else if(b===btn && !correct){ // í‹€ë¦° ë‹µì„ ì„ íƒí–ˆì„ ë•Œ
      b.classList.add("bg-wrong","text-white","border-wrong","shadow-md");
    }
    else { b.classList.add("bg-gray-100","text-gray-400","border-gray-200"); b.classList.remove("bg-white","text-gray-700"); }
  });

  if(!correct){
    if(!wrongQuizzes.some(q=>q.id===quiz.id)){
      wrongQuizzes.push(quiz);
      localStorage.setItem("wrongQuizzes",JSON.stringify(wrongQuizzes));
    }
  } else correctCount++;

  explanationAreaEl.textContent=quiz.explanation;
  explanationAreaEl.classList.remove("hidden");
  nextButtonEl.disabled=false;
  nextButtonEl.classList.remove("opacity-50","cursor-not-allowed");
  nextButtonEl.classList.add("hover:bg-primary-dark");
  updateWrongCount();
}

function updateWrongCount(){ wrongCountEl.textContent=`ì˜¤ë‹µ: ${wrongQuizzes.length}`; }

nextButtonEl.addEventListener("click",()=>{
  currentQuizIndex++;
  if(currentQuizIndex<allQuizzes.length) showQuiz();
  else{
    // ìµœì¢… ê²°ê³¼ í™”ë©´
    explanationAreaEl.textContent=`í€´ì¦ˆ ì™„ë£Œ! ğŸ‰ ì´ ${allQuizzes.length}ë¬¸ì œ ì¤‘ ${correctCount}ë¬¸ì œë¥¼ ë§í˜”ìŠµë‹ˆë‹¤. ì˜¤ë‹µ ${wrongQuizzes.length}ê°œ.`;
    explanationAreaEl.classList.remove("hidden");
    explanationAreaEl.classList.add("bg-yellow-100","border-yellow-500","text-center","font-bold","text-lg");
    nextButtonEl.classList.add("hidden");
    newQuizSetBtnEl.classList.remove("hidden");
    timerEl.textContent = "0";
    timerEl.classList.remove("text-wrong");
  }
});

newQuizSetBtnEl.addEventListener("click", async () => {
    newQuizSetBtnEl.disabled = true;
    newQuizSetBtnEl.classList.add("opacity-50","cursor-not-allowed");
    newQuizSetBtnEl.textContent = "í€´ì¦ˆ ìƒì„± ì¤‘...";
    try {
        const res = await fetch("/api/lawquizzes/new", { method: "POST" });
        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || `ìƒˆ í€´ì¦ˆ ìƒì„± ì‹¤íŒ¨ (Status: ${res.status})`);
        }
        
        const newQuizzes = await res.json();
        
        // âœ… ë””ë²„ê¹… ì¶”ê°€
        console.log('ìƒˆ í€´ì¦ˆ ë°›ìŒ:', newQuizzes);
        console.log('í€´ì¦ˆ ê°œìˆ˜:', newQuizzes.length);
        
        // ìƒˆ ì„¸íŠ¸ë¡œ êµì²´
        allQuizzes = newQuizzes;
        currentQuizIndex = 0;
        correctCount = 0;
        
        console.log('showQuiz í˜¸ì¶œ ì „ allQuizzes:', allQuizzes);
        
        showQuiz();
        updateWrongCount();
        nextButtonEl.classList.remove("hidden");
        newQuizSetBtnEl.classList.add("hidden");

    } catch (err) {
        console.error(err);
        alert(`ìƒˆ í€´ì¦ˆ ì„¸íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`);
    } finally {
        newQuizSetBtnEl.disabled = false;
        newQuizSetBtnEl.classList.remove("opacity-50","cursor-not-allowed");
        newQuizSetBtnEl.textContent = "ìƒˆ í€´ì¦ˆ ì„¸íŠ¸ ìƒì„±";
    }
});

reviewButtonEl.addEventListener("click",()=>{
  reviewListEl.innerHTML="";
  if(wrongQuizzes.length===0){ reviewListEl.innerHTML=`<p class="text-center text-gray-500 py-4">ì•„ì§ í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>`; showModal(); return; }
  wrongQuizzes.forEach((q,i)=>{
    const div=document.createElement("div");
    div.className="review-item p-4 border border-gray-200 rounded-lg bg-gray-50 hover:bg-gray-100 cursor-pointer shadow-sm";
    div.innerHTML=`<p class="text-sm font-light text-gray-500 mb-1">ë³µìŠµ #${i+1}</p>
    <p class="font-bold text-gray-800 mb-2"><span class="text-primary">(${q.category})</span> ${q.question}</p>
    <p class="text-sm"><span class="font-semibold text-wrong">ë‚´ ì„ íƒ:</span> ${q.selectedAnswer||"(ì„ íƒ ì—†ìŒ)"}</p>
    <p class="text-sm"><span class="font-semibold text-correct">ì •ë‹µ:</span> ${q.answer}</p>
    <div class="mt-3 p-2 text-xs bg-blue-100 border-l-2 border-primary rounded text-gray-700">
    <span class="font-bold">í•´ì„¤:</span> ${q.explanation}</div>`;
    div.addEventListener("click",()=>{
      // ë³µìŠµ ë¬¸ì œë¡œ ì´ë™
      const originalIndex = allQuizzes.findIndex(a => a.id === q.id);
      if (originalIndex !== -1) {
          currentQuizIndex = originalIndex;
          showQuiz(); 
          hideModal();
      } else {
          alert("í•´ë‹¹ ë¬¸ì œëŠ” í˜„ì¬ í€´ì¦ˆ ì„¸íŠ¸ì— ì—†ìŠµë‹ˆë‹¤. ìƒˆ ì„¸íŠ¸ ìƒì„± í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
      }
    });
    reviewListEl.appendChild(div);
  });
  showModal();
});
reviewCloseEl.addEventListener("click",()=>hideModal());
reviewModalEl.addEventListener('click',e=>{ if(e.target===reviewModalEl) hideModal(); });

function startTimer(sec){
  timerEl.textContent=sec;
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    sec--;
    timerEl.textContent=sec;
    
    // ğŸŒŸ íƒ€ì´ë¨¸ 5ì´ˆ ë¯¸ë§Œì¼ ë•Œ ìƒ‰ìƒ ë³€ê²½
    if(sec<=5) timerEl.classList.add("text-wrong"); else timerEl.classList.remove("text-wrong");
    
    if(sec<0){
      clearInterval(timerInterval);
      const quiz=allQuizzes[currentQuizIndex];
      // ì´ë¯¸ ë‹µë³€ì´ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš°ë§Œ ì‹œê°„ ì´ˆê³¼ ì²˜ë¦¬
      const isAnswered = Array.from(optionsContainerEl.children).some(b => b.disabled);
      
      if(!isAnswered){
        if(!wrongQuizzes.some(q=>q.id===quiz.id)){
          wrongQuizzes.push(quiz);
          localStorage.setItem("wrongQuizzes",JSON.stringify(wrongQuizzes));
        }
        
        // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™” ë° ì •ë‹µ í‘œì‹œ
        Array.from(optionsContainerEl.children).forEach(b=>{
          b.disabled=true; b.classList.add("cursor-default"); b.classList.remove("hover:bg-gray-50");
          if(b.dataset.isCorrect==="true"){ b.classList.add("bg-correct","text-white","border-correct","shadow-md"); b.classList.remove("bg-white","text-gray-700","border-gray-300"); }
          else { b.classList.add("bg-gray-100","text-gray-400","border-gray-200"); b.classList.remove("bg-white","text-gray-700"); }
        });
        
        quiz.selectedAnswer="(ì‹œê°„ ì´ˆê³¼)";
        explanationAreaEl.textContent=`ì‹œê°„ ì´ˆê³¼! ì •ë‹µ í•´ì„¤: ${quiz.explanation}`;
        explanationAreaEl.classList.remove("hidden");
        explanationAreaEl.classList.add("bg-red-100","border-wrong");
        nextButtonEl.disabled=false; 
        nextButtonEl.classList.remove("opacity-50","cursor-not-allowed"); 
        nextButtonEl.classList.add("hover:bg-primary-dark");
        updateWrongCount();
      }
      return;
    }
  },1000);
}

window.onload=()=>loadQuizzes();
</script>
</body>
</html>
